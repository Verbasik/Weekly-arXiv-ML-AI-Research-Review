# A2A Protocol - Примеры Хостов (Клиентов)

Эта директория содержит примеры приложений или агентов, которые выступают в роли клиентов протокола A2A (Agent-to-Agent) и взаимодействуют с серверами A2A. Эти примеры демонстрируют различные способы использования `A2AClient` и связанных компонентов из библиотеки `common`.

## Содержимое

*   **[CLI (`./cli`)](#cli-хост)**: Инструмент командной строки для интерактивного взаимодействия с A2A сервером.
*   **[Multi-Agent Оркестратор (`./multiagent`)](#multi-agent-оркестратор)**: Пример агента-оркестратора, созданного с использованием Google Agent Development Kit (ADK), который делегирует задачи удаленным A2A агентам.

---

## CLI Хост (`./cli`)

Простой, но функциональный клиент командной строки для отправки запросов A2A агенту и получения ответов.

### Ключевые возможности

*   **Интерактивное взаимодействие:** Позволяет пользователю вводить запросы в командной строке.
*   **Обнаружение агента:** Автоматически получает `AgentCard` с сервера для определения его возможностей.
*   **Поддержка режимов:** Работает как в обычном (запрос-ответ), так и в потоковом (SSE) режиме, в зависимости от возможностей агента.
*   **Управление сессиями:** Позволяет указывать ID сессии или создавать новую.
*   **История сообщений:** Опционально отображает историю диалога в рамках задачи.
*   **Push-уведомления:** Поддерживает получение обновлений от агента через push-уведомления (требует запуска слушателя).
    *   Реализует проверку подлинности push-уведомлений с использованием JWT (через `PushNotificationReceiverAuth`).
    *   Поддерживает механизм валидации URL получателя.

### Файлы

*   `__main__.py`: Основной скрипт CLI. Обрабатывает аргументы командной строки, инициализирует `A2AClient`, управляет циклом взаимодействия с пользователем и агентом, запускает слушатель push-уведомлений при необходимости.
*   `push_notification_listener.py`: Реализует HTTP-сервер (на базе Starlette), который запускается в отдельном потоке для приема и верификации входящих push-уведомлений от A2A агента.

### Использование

Запустите клиент из корневой директории проекта, указав URL целевого A2A агента:

```bash
# Базовый запуск (без стриминга, без push)
python -m hosts.cli --agent http://localhost:10000

# Запуск с использованием push-уведомлений (слушатель запустится на http://localhost:5000)
python -m hosts.cli --agent http://localhost:10000 --use_push_notifications

# Запуск с указанием другого URL для слушателя push-уведомлений
python -m hosts.cli --agent http://localhost:10000 --use_push_notifications --push_notification_receiver http://my-host:6000

# Запуск с отображением истории после завершения задачи
python -m hosts.cli --agent http://localhost:10000 --history

# Запуск с использованием существующего ID сессии
python -m hosts.cli --agent http://localhost:10000 --session <your_session_id>
```

### Зависимости

*   `asyncclick`: Для создания асинхронного CLI.
*   `common`: Использует `A2AClient`, `A2ACardResolver`, `PushNotificationReceiverAuth` и типы данных A2A.

---

## Multi-Agent Оркестратор (`./multiagent`)

Пример интеграции A2A протокола с Google Agent Development Kit (ADK). Этот хост сам является агентом (на базе Gemini), который может понимать запросы пользователя и делегировать выполнение задач подходящим удаленным A2A агентам.

### Ключевые возможности

*   **Интеграция с Google ADK:** Построен как `Agent` с использованием `google-adk`.
*   **Оркестрация:** Использует LLM (Gemini) для выбора удаленного агента и формирования запроса к нему на основе пользовательского ввода и `AgentCard`.
*   **Динамическое обнаружение:** Использует `A2ACardResolver` для получения информации об удаленных агентах при инициализации.
*   **Делегирование задач:** Определяет инструмент (`send_task`) для ADK, который вызывает `A2AClient` (через `RemoteAgentConnections`) для отправки задач удаленным агентам.
*   **Обработка ответов:** Преобразует ответы A2A (включая артефакты и файлы) в формат, понятный Google ADK (`google.genai.types`).
*   **Управление состоянием:** Отслеживает состояние сессии и активного агента в контексте ADK.
*   **Поддержка режимов:** Может взаимодействовать с удаленными агентами как в потоковом (SSE), так и в обычном режиме.

### Архитектура

*   **`HostAgent` (`host_agent.py`):** Основной класс, представляющий агента-оркестратора в ADK.
    *   Инициализируется списком URL удаленных A2A агентов.
    *   Создает и управляет экземплярами `RemoteAgentConnections`.
    *   Определяет инструкцию (промпт) для LLM и инструменты (`list_remote_agents`, `send_task`).
    *   Содержит логику преобразования данных между A2A и ADK (`convert_parts`).
*   **`RemoteAgentConnections` (`remote_agent_connection.py`):** Обертка над `A2AClient` для взаимодействия с одним конкретным удаленным A2A агентом.
    *   Отправляет запросы (`send_task`, `send_task_streaming`).
    *   Обрабатывает опциональные колбэки для обновлений статуса задачи.
    *   Управляет слиянием метаданных между запросами и ответами.
*   **`agent.py`:** Точка инициализации, создающая экземпляр `HostAgent` и регистрирующая его как `root_agent`.

### Использование

Этот хост предназначен для интеграции в более крупное приложение, использующее Google ADK. Основная точка входа - это созданный экземпляр `root_agent`:

```python
# Из hosts/multiagent/agent.py
from .host_agent import HostAgent

# Инициализация корневого агента с указанием адресов удаленных A2A серверов
root_agent = HostAgent(
    remote_agent_addresses=["http://localhost:10000", "http://another-agent:8080"]
).create_agent()

# Далее 'root_agent' может использоваться в приложении ADK
# для обработки запросов пользователя и делегирования задач.
```

### Зависимости

*   `google-adk`: Фреймворк для разработки агентов Google.
*   `google-generativeai`: Для типов данных, используемых ADK.
*   `common`: Использует `A2AClient`, `A2ACardResolver` и типы данных A2A.

```
python -m hosts.cli.__main__ --agent http://localhost:8000
```